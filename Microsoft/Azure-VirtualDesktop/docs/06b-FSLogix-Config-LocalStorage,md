
# 06 ‚Äì FSLogix Configuration (Advanced ‚Äì Local Storage Edition)
![FSLogix](https://img.shields.io/badge/FSLogix-Advanced%20Configuration-orange)
![LocalStorage](https://img.shields.io/badge/Storage-Local%20Disk-blue)
![AVD](https://img.shields.io/badge/Azure%20Virtual%20Desktop-Profiles-0a84ff)

---

# üß≠ 1. Overview

This document provides the **full advanced FSLogix configuration**, matching the structure, tone, and layout of the Azure edition ‚Äî but designed specifically for **local storage** instead of Azure Files or SMB shares.

Local FSLogix is ideal for:

- AVD home labs  
- Proof-of-concept deployments  
- Image building  
- Testing FSLogix behaviour without Azure Files / Kerberos  
- Environments without AADDS  

This version behaves exactly like the Azure edition, but with **zero network dependencies**.

---

# üß± 2. FSLogix Architecture (Local Disk Mode)

```mermaid
flowchart LR
    User["User Logs In"]
    SH["AVD Session Host<br>FSLogix Agent"]
    LOCAL["Local Disk<br>C:\FSLogix\Profiles\<user>.vhdx"]

    User --> SH
    SH -->|Mount VHDX| LOCAL
    LOCAL --> SH
```

Key differences from Azure mode:

| Capability | Azure Files Mode | Local Storage Mode |
|------------|------------------|---------------------|
| Kerberos auth | ‚úî Required | ‚ùå Not used |
| DNS dependency | ‚úî Yes | ‚ùå None |
| NTFS permissions | Share + NTFS | Local NTFS only |
| Performance | Network latency | Local disk speed |
| Best for | Enterprise | Lab / Single host |

---

# üóÇÔ∏è 3. Profile Container vs Office Container

| Feature | Profile Container | Office Container |
|--------|-------------------|------------------|
| Full Windows profile | ‚úî | ‚ùå |
| Outlook OST | ‚úî | ‚úî |
| Search roaming | ‚úî | ‚úî |
| Teams cache | ‚úî | ‚úî |
| Faster login | ‚ùå | ‚úî |

**Recommendation:**  
Use **Profile Container only** for labs unless testing Office split scenarios.

---

# ‚öôÔ∏è 4. FSLogix Base Registry Configuration (Local Mode)

```reg
[HKLM\SOFTWARE\FSLogix\Profiles]
"Enabled"=dword:1
"VolumeType"="vhdx"
"IsDynamic"=dword:1
"SizeInMBs"=dword:30000
"DeleteLocalProfileWhenVHDShouldApply"=dword:1
"FlipFlopProfileDirectoryName"=dword:1
"PreventLoginWithFailure"=dword:1
"VHDLocations"=multi:"C:\FSLogix\Profiles"
```

Create directories:

```powershell
New-Item -ItemType Directory -Path "C:\FSLogix\Profiles" -Force
```

---

# üßπ 5. Redirections.xml (Deep Dive ‚Äî Local Disk Edition)

Same structure as Azure edition but optimised for shrinking the local VHDX:

```xml
<FrxProfileFolderRedirection ExcludeCommonFolders="0">
  <RedirectedFolders>
    <Folder>AppData\Local\Temp</Folder>
    <Folder>AppData\Local\Microsoft\Windows\INetCache</Folder>
    <Folder>AppData\Local\Microsoft\Edge</Folder>
    <Folder>AppData\Local\Microsoft\Teams</Folder>
    <Folder>AppData\LocalLow</Folder>
    <Folder>AppData\Local\CrashDumps</Folder>
  </RedirectedFolders>
</FrxProfileFolderRedirection>
```

Place in:

```
C:\Program Files\FSLogix\Apps\Redirections.xml
```

---

# üå©Ô∏è 6. Cloud Cache (Local-to-Local Redundancy)

Even without Azure Files, Cloud Cache can be used to replicate profiles between local disks:

```reg
[HKLM\SOFTWARE\FSLogix\Profiles]
"CloudCacheEnabled"=dword:1
"CCDLocations"=multi:"type=local,connectionString=C:\FSLogix\Profiles;type=local,connectionString=D:\FSLogixBackup"
```

Useful for:

- Testing corruption handling  
- Simulating multi-disk resilience  

---

# üì¶ 7. VHDX Sizing & Lifecycle

Recommended sizing for local FSLogix:

| Workload | VHDX Size |
|----------|------------|
| Light AVD lab | 10‚Äì20 GB |
| Standard desktop | 20‚Äì30 GB |
| Teams/Office-heavy | 30‚Äì40 GB |

Lifecycle diagram (mirrors Azure edition):

```mermaid
flowchart TD
    Login["User Login"] --> Mount["Mount VHDX"]
    Mount --> Online["Active Session"]
    Online --> Dismount["Dismount on Logoff"]
    Dismount --> Cleanup["Release Handles / Close"]
```

---

# üß∞ 8. FSLogix Logs (Same as Azure Edition)

Log directory:

```
C:\ProgramData\FSLogix\Logs\Profiles
```

Most important logs:

| Log | Purpose |
|------|----------|
| frxsvc.log | Service startup + mount operations |
| profile_load.log | Profile load cycle |
| frxdrv.log | VHDX driver events |

---

# üöÄ 9. Teams & Office Optimisation (Local)

Same structure as Azure version, adapted for local:

```reg
[HKLM\SOFTWARE\Microsoft\Teams]
"IsWVDEnvironment"=dword:1
```

Highly recommended:

- Redirect Teams cache via Redirections.xml  
- Ensure VHDX stays < 20‚Äì30 GB  
- Use clean image with WebView2 preinstalled  

---

# üîê 10. Security Hardening (Local Edition)

Unlike Azure Files, local storage relies only on **NTFS** and **BitLocker**.

### Required NTFS permissions (local folder):

| Identity | Permission |
|----------|-------------|
| Users | Modify |
| SYSTEM | Full Control |
| Administrators | Full Control |

### Highly recommended:

Enable BitLocker:

```powershell
manage-bde -on C:
```

---

# üß™ 11. Troubleshooting Matrix (Matches Azure Version)

| Symptom | Likely Cause | Fix |
|---------|--------------|------|
| Temp profile | VHDLocations misconfigured | Check registry |
| Black login screen | Bloated VHDX / FSLogix hang | Trim VHDX + check redirections.xml |
| `.lock` file persists | VHDX not dismounted cleanly | Delete `.lock` file |
| Very slow login | Large Teams/Edge cache | Add redirections |
| Profile corruption | Bad shutdown / host crash | Reset VHDX |
| FSLogix not loading | Service disabled | Restart `frxsvc` |

---

# ‚úî 12. Summary

Local FSLogix (Advanced Edition) provides:

- ‚úì Zero-dependency FSLogix testing  
- ‚úì Fast logons via local disk  
- ‚úì Ideal lab configuration  
- ‚úì Full compatibility with AVD  
- ‚úì Simple NTFS-based security  
- ‚úì Identical operational flow to Azure edition  

Not recommended for production ‚Äî but **perfect for learning AVD deeply without Azure complexity**.

---

